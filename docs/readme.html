<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.23.0">
    <meta name="project" content="microservice v0.3.0">

    <title>OpenFn/microservice — microservice v0.3.0</title>
    <link rel="stylesheet" href="dist/elixir-9f91ebe876dc01d67920.css" />

    <script src="dist/sidebar_items-b9e5a54e3b.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-60a0c9f10e9e52eae31f.js"></script>

  </head>
  <body data-type="extras">
    <script>try { if(localStorage.getItem('night-mode') === 'true') document.body.className += ' night-mode'; } catch (e) { }</script>

<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <span class="icon-search" aria-hidden="true" title="Submit search"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <span class="icon-cross" aria-hidden="true" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" id="search-list" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="https://openfn.github.io/microservice/readme.html" class="sidebar-projectName">
microservice
      </a>
      <strong class="sidebar-projectVersion">
        v0.3.0
      </strong>
    </div>

      <a href="https://openfn.github.io/microservice/readme.html">
        <img src="assets/logo.png" alt="microservice" class="sidebar-projectImage">
      </a>

  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">Pages</a></li>

      <li><a id="modules-list" href="#full-list">Modules</a></li>


  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>OpenFn/microservice <a href="https://circleci.com/gh/OpenFn/microservice"><img src="https://circleci.com/gh/OpenFn/microservice.svg?style=svg" alt="CircleCI"></img></a></h1><p><a href="https://www.openfn.org"><img src="assets/logo.png" alt="openfn"></img></a>
<a href="https://digitalimpactalliance.org"><img src="https://raw.githubusercontent.com/OpenFn/microservice/master/assets/unicef.png" alt="unicef"></img></a>
<a href="https://www.unicef.org"><img src="https://raw.githubusercontent.com/OpenFn/microservice/master/assets/dial.png" alt="dial"></img></a></p><h2 id="intent" class="section-heading">
  <a href="#intent" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Intent
</h2>
<p>OpenFn is used by numerous health and humanitarian organizations around the
world to scale their programs through real-time interoperability, systems
integration, and workflow automation. <strong>OpenFn/microservice</strong> makes use of
OpenFn's open-core technology—namely <strong>OpenFn/core</strong> and the various OpenFn
<strong>adaptors</strong>—to create standalone microservices which can be deployed on any
hardware.</p><p>This microservice approach helps to ensure that governments and NGOs are never
locked-in to OpenFn's SaaS offering, and can port their existing jobs, triggers,
and credentials from <a href="www.openfn.org">OpenFn.org</a> to their own infrastructure
easily.</p><h2 id="prerequisites" class="section-heading">
  <a href="#prerequisites" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Prerequisites
</h2>
<ul><li>Familiarity with OpenFn's open-source integration tools. (See <a href="https://docs.openfn.org">OpenFn/docs</a>, <a href="https://github.com/openFn/engine">OpenFn/engine</a>, <a href="https://openfn.github.io/devtools/">OpenFn/devtools</a>, and <a href="https://github.com/openFn/core">OpenFn/core</a></li></ul><h2 id="docker-usage" class="section-heading">
  <a href="#docker-usage" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Docker usage
</h2>
<ul><li><code class="inline">git clone git@github.com:OpenFn/microservice.git &amp;&amp; cd microservice</code> to clone</li><li><code class="inline">cp project.yaml.example project.yaml</code> to set up a basic project</li><li><code class="inline">docker build -t openfn/microservice:v0.3.0 .</code> to build</li><li><code class="inline">cp .env.example .env</code> to configure</li><li><code class="inline">docker run --network host --env-file ./.env openfn/microservice:v0.3.0</code> to run</li></ul><h2 id="development-up-and-running-guide" class="section-heading">
  <a href="#development-up-and-running-guide" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Development up and running guide
</h2>
<ul><li>Clone this repo with <code class="inline">git clone git@github.com:OpenFn/microservice.git</code></li><li>Enter the directory with <code class="inline">cd microservice</code></li><li>Install dependencies with <code class="inline">mix setup</code></li><li>Create a new project configuration file <code class="inline">cp project.yaml.example project.yaml</code></li><li>Run the tests with <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a></li><li>Create a <code class="inline">.env</code> file with <code class="inline">cp .env.example .env</code></li><li>Start your server with <code class="inline">env $(cat .env | grep -v &quot;#&quot; | xargs ) iex -S mix phx.server</code></li></ul><h2 id="sample-configuration" class="section-heading">
  <a href="#sample-configuration" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Sample configuration
</h2>
<p>The <a href="https://github.com/OpenFn/microservice/blob/main/project.yaml.example">sample project configuration file</a> describes the example project setup to help you get acquainted with the structure of the jobs, language packs and triggers.</p><p>By default microservice is configured with 4 sample jobs:</p><ol><li><code class="inline">job-1</code> shows a run log and it is triggered when a matching message arrives to the inbox (<code class="inline">trigger-2</code>).</li><li><code class="inline">job-cron</code> is a timed job scheduled to run every minute and is linked to the <code class="inline">every-minute</code> cron trigger.</li><li><code class="inline">job-2</code> and <code class="inline">job-3</code> are not set up with any job expression but are linked to <code class="inline">trigger-3</code>.</li></ol><p>All of the jobs are configured with the language pack <code class="inline">openfn/language-common</code>.</p><p>In the default sample configuration a new message posted to <code class="inline">localhost:4000/inbox</code> that matches <code class="inline">trigger-2</code> (i.e. the message contains <code class="inline">“number”:2</code>) is greeted with an asynchronous acknowledgement receipt (<code class="inline">HTTP 202</code> <code class="inline">Data accepted and processing has begun</code>) and will trigger <code class="inline">job-1</code> to run.</p><p>You can try this out with the following snippet:</p><pre><code class="nohighlight makeup elixir"><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="nc">X</span><span class="w"> </span><span class="nc">POST</span><span class="w"> </span><span class="o">-</span><span class="nc">H</span><span class="w"> </span><span class="s">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="err">\</span><span class="w">
 </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="sc">&#39;{
  &quot;number&quot;:2,
  &quot;surveyId&quot;: 37479
}&#39;</span><span class="w"> </span><span class="err">\</span><span class="w">
 </span><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">localhost</span><span class="p">:</span><span class="mi">4000</span><span class="o">/</span><span class="n">inbox</span></code></pre><p>Posting a message not matching any of the triggers (e.g. <code class="inline">“number”:3</code>) equally prompts an acknowledgement but doesn’t trigger any jobs.</p><p>Example message post for this non-match scenario:</p><pre><code class="nohighlight makeup elixir"><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="nc">X</span><span class="w"> </span><span class="nc">POST</span><span class="w"> </span><span class="o">-</span><span class="nc">H</span><span class="w"> </span><span class="s">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="err">\</span><span class="w">
 </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="sc">&#39;{
  &quot;number&quot;:3,
  &quot;surveyId&quot;: 37479
}&#39;</span><span class="w"> </span><span class="err">\</span><span class="w">
 </span><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">localhost</span><span class="p">:</span><span class="mi">4000</span><span class="o">/</span><span class="n">inbox</span></code></pre><p>HTTP <code class="inline">post</code> requests made to
<a href="http://localhost:4000/inbox"><code class="inline">localhost:4000/inbox</code></a> will be processed by the
<code class="inline">Receiver |&gt; Dispatcher</code>, according to the <code class="inline">credential</code>, <code class="inline">expression</code>, and
<code class="inline">adaptor</code> defined in your <code class="inline">.env</code> file.</p><p>Time-based jobs will be run by <code class="inline">Repeater |&gt; Dispatcher</code> according to the
<code class="inline">credential</code>, <code class="inline">expression</code>, and <code class="inline">adaptor</code> defined in your <code class="inline">.env</code> file.</p><h2 id="development" class="section-heading">
  <a href="#development" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Development
</h2>
<p>This is a rough draft. Note that we're using the BEAM here because we see this
growing significantly and want to leverage inter-node communication on large
deployments, among other things. We may also fork and go another direction,
using nothing but a small Express server (dropping Elixir/Erlang entirely) to
call OpenFn/core (with a directly Javascript interface, rather than the CLI).
Ideas, suggestions, questions welcome.</p><h3 id="potential-roadmap-for-this-application" class="section-heading">
  <a href="#potential-roadmap-for-this-application" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Potential roadmap for this application
</h3>
<ul><li>[x] <a href="https://hexdocs.pm/phoenix/1.5.6/Mix.Tasks.Phx.Server.html"><code class="inline">mix phx.server</code></a> receives receipts and sends 201/202</li><li>[x] timer jobs can keep state (via <code class="inline">Repeater</code> and a simple <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a>)</li><li>[x] endpoint gets <code class="inline">URL</code> and <code class="inline">PORT</code> from <code class="inline">.env</code></li><li>[x] <code class="inline">Dispatcher</code> picks up config from <code class="inline">.env</code></li><li>[x] <code class="inline">Dispatcher</code> executes it, given preloaded job, cred, adaptor, and core</li><li>[x] write tests for everything</li><li>[x] dashboard for visual performance monitoring</li><li>[ ] pass project artifacts during <code class="inline">docker run</code></li><li>[ ] <code class="inline">tmp</code> files are deleted after job is run</li><li>[x] chain jobs together (replicate OpenFn.org &quot;flow&quot;)</li><li>[ ] bring <code class="inline">core</code> out of package.json</li><li>[ ] <code class="inline">Engine</code> can pipe to stdout</li><li>[ ] notifications module</li><li>[ ] better Logging</li><li>[ ] visual interface for application (Phx LiveView?)</li><li>[ ] message persistence plugin (enables retries)</li></ul><h3 id="dynamic-configuration-required-for-mvp" class="section-heading">
  <a href="#dynamic-configuration-required-for-mvp" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Dynamic Configuration required for MVP
</h3>
<ul><li>See <a href="https://github.com/OpenFn/microservice/blob/master/project">/project</a> for
project artifacts</li><li>See
<a href="https://github.com/OpenFn/microservice/blob/master/.env.example">.env.example</a>
for a possible configuration</li><li>See
<a href="https://github.com/OpenFn/microservice/blob/master/Dockerfile">Dockerfile</a> to
build a microservice</li></ul><h3 id="how-to-make-it-shelf-ready" class="section-heading">
  <a href="#how-to-make-it-shelf-ready" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  How to make it shelf ready
</h3>
<ol><li>Build a fully featured documentation site like
<a href="https://docs.openfn.org">OpenFn/docs</a></li><li>Make fully <code class="inline">Instant OpenHIE</code> compliant (including <code class="inline">kubernetes.yaml</code>)</li><li>Build out <code class="inline">openfn-devtools</code> to include a script that pulls and configures
<code class="inline">microservice</code> based one the current configuration of jobs and credentials in
<code class="inline">devtools</code>.</li><li>Click a button on OpenFn to prepare a <code class="inline">microservice.zip</code> which is this repo
with a new Dockerfile, based on the current job's configuration at OpenFn.org
(we're not just &quot;shelf ready&quot;, we're <em>providing the shelf</em> with a &quot;free
forever&quot; project on our website.)</li><li>An open-source jobs library.</li></ol><h3 id="jobs-library" class="section-heading">
  <a href="#jobs-library" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Jobs Library
</h3>
<ol><li>All jobs that &quot;opt-in&quot; on OpenFn.org are exposed with an open API, which
<strong>expects</strong> <code class="inline">{adaptor, version, ...helperFunction}</code> and <strong>returns</strong> the
following—which includes both the jobs in the OpenFn.org database <em>and</em> the
jobs in <a href="https://www.github.com/openfn/docs/jobs">OpenFn/Docs/jobs</a>:</li></ol><pre><code class="json">[
  {
    &quot;expression&quot;: &quot;createTEI({})&quot;,
    &quot;active&quot;: true,
    &quot;runsLast90&quot;: 32178,
    &quot;successRateLast90&quot;: 0.973,
    &quot;source&quot;: &quot;openfn.org&quot;
  },
  {
    ...job,
    &quot;source&quot;: &quot;openfn/docs&quot;
  }
]</code></pre><ol start="2"><li>That API is consumed by the docs site (open source) <em>AND</em> by openfn.org so
that it can use used to generate jobs with our free-forever projects.</li><li>In the IDE on OpenFn.org, a user clicks DHIS2, then <code class="inline">createTEI</code> and it
suggests that you look at the top 10 most <code class="inline">successful/active</code>
dhis2:your-version expressions, searchable and copy/pastable.</li><li>New jobs are automatically added to the library from OpenFn.org, and
open-source users can submit pull requests to post their jobs to the
<code class="inline">OpenFn/docs/</code> repo. (OpenFn/docs is open source also, btw.)</li></ol>
      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.23.0) for the
            <a href="https://elixir-lang.org" title="Elixir" target="_blank">Elixir programming language</a>.
          </span>
          <span class="line">
            Designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>

            <a href="api-reference.html" title="API reference" class="line footer-button">API Reference</a>

          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>

  </body>
</html>
