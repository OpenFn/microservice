# Elixir CircleCI 2.0 configuration file
# Check https://circleci.com/docs/2.0/language-elixir/ for more details
version: 2
jobs:
  tests:
    docker:
      - image: circleci/elixir:1.11.3-node
        environment:
          MIX_ENV: test

    working_directory: ~/repo
    steps:
      - checkout

      - run: mkdir ./tmp
      - run: mix local.hex --force
      - run: mix local.rebar --force
      - run: mix do setup, deps.compile, compile
      - run: mix coveralls.json -o ./tmp

      - store_test_results:
          path: ./tmp
  build:
    docker:
      - image: circleci/elixir:1.11.3-node

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.2
          # docker_layer_caching: true

      - run: docker build -t openfn-microservice .
      - run: | 
          docker run -d --rm \
            --name openfn-microservice-test \
            -p 4000:4000 \
            -e HOST_URL=localhost \
            -e PORT=4000 \
            -e ENDPOINT_STYLE=sync \
            -e PROJECT_DIR=/opt/app/project \
            -v $PWD/docker/example/volume:/opt/app/project \
            openfn-microservice

      - run: |
          docker exec \
            openfn-microservice-test \
            curl --retry 10 --retry-connrefused http://localhost:4000


